<!--

=========================================================
* Argon Dashboard - v1.1.2
=========================================================

* Product Page: https://www.creative-tim.com/product/argon-dashboard
* Copyright 2020 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://github.com/creativetimofficial/argon-dashboard/blob/master/LICENSE.md)

* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. -->
{% load static %}
{% load socialaccount %}
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>
    HEY, 재무분석
  </title>
  <!-- Favicon -->
  <link href="{%static '/assets/img/brand/favicon.png' %}" rel="icon" type="image/png">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
  <!-- Icons -->
  <link href="{%static '/assets/js/plugins/nucleo/css/nucleo.css' %}" rel="stylesheet" />
  <link href="{%static '/assets/js/plugins/@fortawesome/fontawesome-free/css/all.min.css' %}" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="{%static '/assets/css/argon-dashboard.css'%}?v=1.1.2" rel="stylesheet" />
  <style>
      @keyframes spinner-grow{0%{transform:scale(0)}50%{opacity:1;transform:none}}
      .spinner-grow{display:inline-block;width:2rem;height:2rem;vertical-align:-.125em;
        background-color:currentColor;border-radius:50%;opacity:0;animation:.75s 
        linear infinite spinner-grow}
        .spinner-grow-sm{width:1rem;height:1rem}
        @media (prefers-reduced-motion: reduce){.spinner-border,.spinner-grow{animation-duration:1.5s}}
      .spin-class{
        z-index : 11;
      }
  </style>
</head>

<body class="scrollbar" style="overflow-x:hidden;">
  <nav class="navbar navbar-vertical fixed-left navbar-expand-md navbar-light bg-white" id="sidenav-main">
    <div class="container-fluid">
      <!-- Toggler -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#sidenav-collapse-main" aria-controls="sidenav-main" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Brand -->
      <a href="/" class="navbar-brand p-0">
        <h1 class="m-0">Hey, 금융</h1>
        <!-- <img src="img/logo.png" alt="Logo"> -->
      </a>
      <!-- User -->
      <ul class="nav align-items-center d-md-none">
        <li class="nav-item dropdown">
          <a class="nav-link nav-link-icon" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="ni ni-bell-55"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right" aria-labelledby="navbar-default_dropdown_1">
            <a class="dropdown-item" href="#">Action</a>
            <a class="dropdown-item" href="#">Another action</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#">Something else here</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <div class="media align-items-center">
              <span class="avatar avatar-sm rounded-circle">
                <img alt="Image placeholder" src="./assets/img/theme/team-1-800x800.jpg">
              </span>
            </div>
          </a>
          <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
            <div class=" dropdown-header noti-title">
              <h6 class="text-overflow m-0">Welcome!</h6>
            </div>
            <a href="./examples/profile.html" class="dropdown-item">
              <i class="ni ni-single-02"></i>
              <span>My profile</span>
            </a>
            <a href="./examples/profile.html" class="dropdown-item">
              <i class="ni ni-settings-gear-65"></i>
              <span>Settings</span>
            </a>
            <a href="./examples/profile.html" class="dropdown-item">
              <i class="ni ni-calendar-grid-58"></i>
              <span>Activity</span>
            </a>
            <a href="./examples/profile.html" class="dropdown-item">
              <i class="ni ni-support-16"></i>
              <span>Support</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="#!" class="dropdown-item">
              <i class="ni ni-user-run"></i>
              <span>Logout</span>
            </a>
          </div>
        </li>
      </ul>
      <!-- Collapse -->
      <div class="collapse navbar-collapse" id="sidenav-collapse-main">
        <!-- Collapse header -->
        <div class="navbar-collapse-header d-md-none">
          <div class="row">
            <div class="col-6 collapse-brand">
              <a href="./index.html">
                <img src="{%static '/assets/img/brand/blue.png' %}">
              </a>
            </div>
            <div class="col-6 collapse-close">
              <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#sidenav-collapse-main" aria-controls="sidenav-main" aria-expanded="false" aria-label="Toggle sidenav">
                <span></span>
                <span></span>
              </button>
            </div>
          </div>
        </div>
        <!-- Form -->
        <form class="mt-4 mb-3 d-md-none">
          <div class="input-group input-group-rounded input-group-merge">
            <input type="search" class="form-control form-control-rounded form-control-prepended" placeholder="Search" aria-label="Search">
            <div class="input-group-prepend">
              <div class="input-group-text">
                <span class="fa fa-search"></span>
              </div>
            </div>
          </div>
        </form>
        <!-- Navigation -->
        <ul class="navbar-nav">
          <li class="nav-item  active ">
            <a class="nav-link  active " href="javascript:void(0)">
              <i class="ni ni-tv-2 text-primary"></i> 재무분석
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link " href="/summary/exchange_rate">
              <i class="ni ni-bullet-list-67 text-red"></i> 환율
            </a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link " href="/summary/gold_rate">
              <i class="ni ni-bullet-list-67 text-red"></i> 금
            </a>
          </li>
        </ul>
        <!-- Divider -->
        <hr class="my-3">
        <!-- Heading -->
        <h6 class="navbar-heading text-muted">금융 Docs</h6>
        <!-- Navigation -->
        <ul class="navbar-nav mb-md-3">
          <li class="nav-item">
            <a class="nav-link" href="https://www.fsc.go.kr/in090301">
              <i class="ni ni-spaceship"></i> 금융위원회
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://www.fsc.go.kr/in090301">
              <i class="ni ni-palette"></i> 구독하기
            </a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item active active-pro">
            <a class="nav-link" href="./examples/upgrade.html">
              <i class="ni ni-send text-dark"></i> 이메일
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="main-content">
    <!-- Navbar -->
    <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
      <div class="container-fluid">
        <!-- Brand -->
        <a class="h4 mb-0 text-white text-uppercase d-none d-lg-inline-block">Dashboard</a>
        
        <!-- User -->
        <ul class="navbar-nav align-items-center d-none d-md-flex">
          <li class="nav-item dropdown">
            <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <div class="media align-items-center">
                <div class="media-body ml-2 d-none d-lg-block">
                  <a href="#"id="username" class="btn-welcome py-2 px-4 ms-3 d-none d-lg-block text-white">{{user.name}}님 반갑습니다.</a>
                </div>
              </div>
            </a>
            <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-right">
              <div class=" dropdown-header noti-title">
                <h6 class="text-overflow m-0">환영합니다!</h6>
              </div>     
              <a href="./examples/profile.html" class="dropdown-item">
                <i class="ni ni-settings-gear-65"></i>
                <span>설정</span>
              </a>
              <a href="./examples/profile.html" class="dropdown-item">
                <i class="ni ni-calendar-grid-58"></i>
                <span>활동</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="/accounts/logout" class="dropdown-item">
                <i class="ni ni-user-run"></i>
                <span>로그아웃</span>
              </a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <!-- End Navbar -->
    
    <!-- Header -->
    <div class="header pb-8 pt-5 pt-md-8" style="background: linear-gradient(87deg, #94bbe9  0px, #3498db 100%);">
      <div class="container-fluid">
        <div class="header-body">
          <!-- Search Button -->
          <form id='search_form' class="navbar-search navbar-search-dark form-inline" onsubmit='return test();'>
            <div class="form-group">
              <div class="input-group input-group-alternative">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
                <input id='corp_name' class="form-control custom-width-input" placeholder="정확한 기업명을 입력해주세요" type="text">
            </div>
            <span id='search_error' class='text-red mt-3' style='display:none;'>해당 기업과 관련된 정보를 찾지 못했어요. DART와 거래소에 등록된 기업이름인지 확인해주세요</span>
          </form>
          
        </div>
          <!-- Spinner Start -->
          <div class="d-flex justify-content-center">
            <div class="spin-class spinner-grow text-light" style="width: 10rem; height: 10rem; display: none;" role="status">
            </div>
          </div>
          <div class="d-flex justify-content-center mt-5">
            <h2 class="spin-class text-light" style="display: none;">기업 정보를 열심히 공부하고 있어요!&nbsp&nbsp&nbsp잠시만 기다려주세요..<br><br>내용이 많은 경우에는 최대 1분 정도 걸릴수도 있어요</h2>
          </div>
          <!-- Card stats -->
          <div class="row summary_card">
            <div class="col-xl-3 col-lg-6">
              <div class="card-2 card-stats mb-4 mb-xl-0">
                <div class="card-2-body shadow">
                  <div class="row">
                    <div class="col">
                      {% comment %} <h5 class="card-2-title text-uppercase text-muted mb-0">요약 소개</h5> {% endcomment %}
                      <span class="h2 font-weight-bold mb-0">주식 그래프</span>
                      <div class="chart-example">
                      </div>
                    </div>
                    
                  </div>
                  <p class="mt-3 mb-0 text-muted text-sm">
                  </p>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-lg-6">
              <div class="card-2 card-2-stats mb-4 mb-xl-0">
                <div class="card-2-body">
                    <div class="col">
                      <span id='corp_intro' class="h2 font-weight-bold mb-0"></span>
                      <div id="corp_info" class="news-text tooltiptext "></div>
                    </div>
                    <div id="financial_summary" class="news-text">
                    </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-lg-6">
              <div class="card-2 card-2-stats mb-4 mb-xl-0">
                <div class="card-2-body">
                  {% comment %} <h5 class="card-2-title text-uppercase text-muted mb-0">현재 날짜 {%now "Y-m-d "%}</h5> {% endcomment %}
                  <span class="h2 font-weight-bold mb-0">뉴스 요약</span>
                  <div id="corp_news" class = "jb-container">
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-lg-6">
              <div class="card-2 card-2-stats mb-4 mb-xl-0">
                <div class="card-2-body">
                  <div class="row">
                    <div class="col">
                      {% comment %} <h5 class="card-2-title text-uppercase text-muted mb-0">실시간</h5> {% endcomment %}
                      <span class="h2 font-weight-bold mb-0">국내 지수</span>
                    </div>
                    <div class="col-auto">
                      
                    </div>
                    
                  </div>
                  <div id='stock_data' class = "jb-container">
                    
                  </div>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 차트 그려지는 공간-->
    <div class="container-fluid mt--7 summary_card">
      <div class="row">
        <div class="col-xl-8 mb-5 mb-xl-0">
          <div class="card bg-gradient-default shadow">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-uppercase text-light ls-1 mb-1">재무분석 차트</h6>
                  <h2 id='corp_financial_reports' class="text-white mb-0"></h2>
                  
                </div>
                <div class="col">
                  <ul class="nav nav-pills justify-content-end">
                    <li class="nav-item mr-2 mr-md-0" data-toggle="chart" data-target="#chart-sales2" 
                     data-prefix="￦" data-suffix="K">
                      <a id="sales2023" href="#" class="nav-link py-2 px-3 active" data-toggle="tab" onclick="updateSalesChart([1,1,1,1]);return false;">
                        <span class="d-none d-md-block">2023</span>
                        <span class="d-md-none">M</span>
                      </a>
                    </li>
                    <li class="nav-item" data-toggle="chart" data-target="#chart-sales2"
                     data-prefix="￦" data-suffix="K">
                      <a id="sales2022" href="#" class="nav-link py-2 px-3" data-toggle="tab" onclick="updateSalesChart([1,1,1,1]);return false;">
                        <span class="d-none d-md-block">2022</span>
                        <span class="d-md-none">W</span>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="card-body">
              <!-- Chart 차트 여기부터-->
              <div class="chart">
                <!-- Chart wrapper -->
                <canvas id="chart-sales2" class="chart-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-chat-bot">
          <div class="card shadow">
            <div class="card-header bg-transparent">
              <div class="row align-items-center">
                <div class="col">
                  <br>
                  <h2 class="mb-0" id="news-title">기업 Chatbot</h2>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-custom scrollbar" style="max-height: 300px; overflow-y: auto;">
                <!-- 사용자 질문과 챗봇 답변을 표시하는 대화창 -->
                <div class="news-text" id='chatbot_conversation'></div>
                
              </div>
            </div>
            <div class="card-footer-2">
              <div class="send">
                <!-- 사용자가 메세지를 입력할 수 있는 텍스트 영역과 전송 버튼 -->
                <textarea class="send-text" placeholder="메세지를 입력하세요" id="message-input"></textarea>
                <button class='send-btn' onclick="sendMessage()">전송</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!--ROE, PER, PBR, 부채 등등...재무제표 쉽게 알려주기-->
        <div class="row-2 mt-5">
          <div class="row-2">
            <div class="col-xl-custom">
              <div class="card-3 card-3-stats mb-4">
                <div class="row">
                  <div class="col">
                    <div class="card-3-body">
                      <h5 class="card-3-title text-uppercase text-muted mb-0">단위 : %</h5>
                      <span class="h2 font-weight-bold mb-0" >부채 현황</span>
                      <canvas id="chart-dept" class="chart-dept" ></canvas>
  
                       <div class = "jb-container">
        
                      </div>
                    </div>
                  </div>
                  
                </div>
                  
              </div>
            </div>
  
            <div class="col-xl-custom">
              <div class="card-3 card-3-stats mb-4" id="chart-dept-card">
                <div class="card-3-body">
                  <div class="row-2">
                    <div class="card-4-body">
                      <span class="h2 font-weight-bold mb-0">금리 현황</span>
                      <canvas id="chart-interest" class="chart-canvas"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
  
          </div>
        </div>
        <!-- 삼각형 주가 타당성 비교 // 고평가 vs 저평가 -->
        <div class="row-3 mt-5">
          <div class="row-3">
            <div class="col-xl-custom2">
              <div class="card-3 card-3-stats mb-4" >
                <div class="card-4-body" id="expandableCard">
                  <div id="triangleContainer" style="float:left;"></div>
                  <div id="triangle-value"></div>
                  <div id="myChart" style="width: 500px; height: 440px; max-width:500px; float:left; max-heigth:440px;"></div>
                  <table class="triangle-text">
                    <tr>
                      <td><strong>1.</strong></td>
                      <td><strong>ROE (자기자본이익률)</strong> : <strong>⬆️ 높을수록 좋음</strong>  : 높은 ROE는 기업이 효과적으로 자본을 활용하고 있다는 것을 나타내며 투자자에게 긍정적인 신호입니다.
                        <br>회사의 순이익이 <strong>100억</strong>이고 <strong>ROE가 10%</strong>이면 자기자본 수익률은 <strong>10억</strong>입니다.<br>
                        시가총액이 200억이면 <strong>PBR은 200억 / 10억 = 20</strong>이 됩니다. 따라서 주가는 자기자본 수익의 20배입니다.`</td>
                    </tr>
                    <tr>
                      <td><strong>2.</strong></td>
                      <td><strong>PER (주가수익비율)</strong> : <strong>⬇️ 낮을수록 좋음</strong> : 낮은 PER은 주가 대비 수익이 높다는 것을 의미하며, 저평가 기업을 찾을 때 유용합니다.<br>
                        <strong>PER이 20</strong>이라면 주가 대비 순이익이 20배입니다. 주가는 <strong>10억 × 20 = 200억</strong>이 됩니다.</td>
                    </tr>
                    <tr>
                      <td><strong>3.</strong></td>
                      <td><strong>PBR (주가순자산비율)</strong>: <strong>⬇️ 낮을수록 좋음</strong>  : 낮은 PBR은 주가가 자본에 비해 저평가되어 있다는 신호로 가치투자에 유리합니다.<br>
                        <strong>PBR이 2</strong>라는 것은 주가가 순자산에 비해 2배 비쌌다는 것을 의미합니다. 자기자본이 100억이면 주가는 <strong>100억 × 2 = 200억</strong>이 됩니다.</td>
                
                    </tr>
                    <tr>
                      <td><strong>4.</strong></td>
                      <td><strong>BPS (주당순자산가치)</strong> : <strong>⬆️ 높을수록 좋음</strong>  : 높은 BPS는 주당 자산가치가 높다는 것을 나타내어 가치투자에 긍정적입니다.</td>
                
                    </tr>
                    <tr>
                      <td><strong>5.</strong></td>
                      <td><strong>EPS (주당순이익)</strong> : <strong>⬆️ 높을수록 좋음</strong> : 높은 EPS는 주당 이익이 높다는 것을 의미하며 투자자에게 긍정적입니다.</td>
                
                    </tr>
                    <tr>
                      <td><strong>6.</strong></td>
                      <td>SKT, KT, 하이닉스, 전력공사 같은 기업들은 기업의 성장 가능성보다는 주로 회사의 실적이 주가를 결정 지으므로 대체적으로 PBR이 낮은 편에 속한다.</td>
                    </tr>
                    <tr>
                      <td><strong>7.</strong></td>
                      <td>벤처기업, 바이오업계, 제약회사 등은 실적보다는 미래의 성장가능성이 주로 주가를 결정 짓는다. 이 회사들은 BPR이 굉장히 높다.</td>
                    </tr>
                    <tr>
                      <td><strong>8.</strong></td>
                      <td>코스피는 한국 증권 거래소(KRX)에서 거래되는 대표적인 주식 시장으로, 대기업의 종목들이 주로 상장돼 있습니다. 코스닥은 코스피와 함께 한국의 또 다른 증권 거래소로, 중소기업들의 주식이 주로 거래됩니다.</td>
                    </tr>
                    <tr>
                      <td><strong>9.</strong></td>
                      <td>금리는 돈의 시간 가치를 나타내는 지표로, 대출이나 예금 시에 발생하는 이자율을 의미합니다. 중앙 은행이 정책금리를 조절하여 경제의 안정을 유지하고 소비 및 투자 활동을 조절합니다.</td>
                    </tr>
                    <tr>
                      <td><strong>10.</strong></td>
                      <td>매수는 주식이나 다른 자산을 구매하는 행위를 말합니다. 투자자는 자산의 가격이 상승할 것으로 예상하면 매수를 선택하여 보유하거나 가격이 떨어질 때 팔 수 있습니다.
                        매도는 보유 중인 주식이나 자산을 판매하는 행위를 의미합니다. 투자자는 가격이 상승한 시점에 매도하여 수익을 얻거나, 손실을 최소화하기 위해 가격이 하락할 것으로 예상될 때 팔 수 있습니다.
                      </td>
                    </tr>
                  </table>
                
                </div>
                <button id="expandButton">Expand</button>
              </div>
            </div>
          </div>
        </div>
      
      <!-- Footer -->
      
      <footer class="footer">
        <div class="row align-items-center justify-content-xl-between">
          <div class="col-xl-6">
            <div class="copyright text-center text-xl-left text-muted">
              &copy; 2018 <a href="https://www.creative-tim.com" class="font-weight-bold ml-1" target="_blank">Creative Tim</a>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </div>
  <div id="spinner_background" class="spin-class" style="width:100%; height:100%; margin:0 auto; padding:0; border:none; float:top; position:fixed; top:0%; z-index:10; background-color:rgba(0, 0, 0, 0.3); display:none;"></div>
  <!--   Core   -->
  <script src="{%static '/assets/js/plugins/jquery/dist/jquery.min.js' %}"></script>
  <script src="{%static '/assets/js/plugins/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
  <!--   Optional JS   -->
  <script src="{%static '/assets/js/plugins/chart.js/dist/Chart.min.js' %}"></script>
  <!-- 그래프 모양과 관련됨   -->
  <script src="{%static '/assets/js/plugins/chart.js/dist/Chart.extension.js' %}"></script>
  <!--   Argon JS   -->
  <script src="{%static '/assets/js/argon-dashboard.min.js'%}"></script>
  <script src="https://cdn.trackjs.com/agent/v3/latest/t.js"></script>

  <script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }}"; </script>
  <!-- D3.js -->
<script src="https://d3js.org/d3.v5.min.js"></script>

  <script>
    let salesChart;
    let deptChart;
    interestChart = function () {
      var e, a, t = $("#chart-interest");
      var initialData = {
        labels: ["한국", "미국"],
        datasets: [{
          label: "금리 값",
          data: [3.25, 5.25],
          backgroundColor: ['blue', 'red'] // Adjust colors as needed
        }]
      };
      if (t.length) {
        e = t;
        a = new Chart(e, {
          type: "horizontalBar",
          options: {
            responsive: true,
            maintainAspectRatio: true,
            legend: {
              display: true,
              position: 'right',
              labels: {
                fontColor: 'black'
              }
             
            },
            tooltips: {
              callbacks: {
                label: function (e, a) {
                  var t = a.labels[e.index] || "",
                    o = a.datasets[0].data[e.index],
                    n = "";
                  return n += '<span class="popover-body-value">' + t + ":" + o + "%</span>"
                }
              }
            },
           
            plugins: {
              labels: {
                render: 'percentage',
                fontColor: ['#ff0000', '#0000ff'],
                precision: 2
               
              }
            }
          },
          data: initialData
        }), e.find("canvas").attr("width", "100").attr("height", "100"), e.data("chart", a)
      }
    }();
 
    
    // PBR/PER 계산 함수
    function calculatePBRPER() {
      // 여기에 계산 로직 추가
      return 4.5; // 예시 값
    }
    
    // EPS/BPS 계산 함수
    function calculateEPSBPS() {
      // 여기에 계산 로직 추가
      return 3.8; // 예시 값
    }
    
    // ROE 계산 함수
    function calculateROE() {
      // 여기에 계산 로직 추가
      return 5.2; // 예시 값
    }
    
    
  function drawSalesChart(e,data){
    salesChart = new Chart(e, {
      type: "bar",
      options: {
        scales: {
          yAxes: [
            {
              gridLines: {
                lineWidth: 1,
                color: Charts.colors.gray[900],
                zeroLineColor: Charts.colors.gray[900],
              },
              ticks: {
                beginAtZero:false,
                callback: function (e) {
                  if (!(e % 10)) return "￦" + e.toLocaleString('ko-KR') + "M";
                },
              },
            },
          ],
        },
        tooltips: {
          callbacks: {
            label: function (e, a) {
              var t = a.datasets[e.datasetIndex].label || "",
                o = e.yLabel,
                n = "";
              return (
                1 < a.datasets.length &&
                  (n +=
                    '<span class="popover-body-label mr-auto">' +
                    t +
                    "</span>"),
                (n += '<span class="popover-body-value">￦' + o.toLocaleString('ko-KR') + "M</span>")
              );
            },
          },
        },
      },
      data: {
        labels: ["부채", "영업이익", "매출액", "당기순이익"],
        datasets: [
          {
            label: "Performance",
            data: data,
            borderWidth: 10,
            borderColor: "rgba(255, 99, 132, 1)",
          },
        ],
      },
    })
  }
  

  $(function () {
    // 툴팁 초기화
    $('[data-toggle="tooltip"]').tooltip();
  });
  
  $("#search_form").submit(function(e) {
    e.preventDefault();
  });

  $(document).ready(function () {
    //$('.summary_card').hide();
    $("#chart-dept-card").hover(
      function () {
        $("#chart-dept-title").css("display", "block");
      },
      function () {
        $("#chart-dept-title").css("display", "none");
      }
    );
    
  });

  function drawDeptChart(e,data){
    var initialData = {
      labels: ["부채", "자본"],
      datasets: [{
        label: "부채 비율",
        data: data,
        backgroundColor: ['warning', '#fb6340'] // Adjust colors as needed
      }]
    };
    deptChart = new Chart(e, {
      type: "doughnut",
      options: {
        is3D: true,
        responsive: true,
        maintainAspectRatio: true,
        cutoutPercentage: 20,
        legend: {
          display: true,
          position: 'right',
          labels: {
            fontColor: 'black'
          }
        },
        tooltips: {
          callbacks: {
            label: function (e, a) {
              var t = a.labels[e.index] || "",
                o = a.datasets[0].data[e.index],
                n = "";
              return n += '<span class="popover-body-value">' + t + ":" + o + "%</span>"
            }
          }
        },
        plugins: {
          labels: {
            render: 'percentage',
            fontColor: ['#ff0000', '#0000ff'],
            precision: 2
            
          }
        }

      },
      data: initialData
    })
  }


  // 회사의 Roe, PBR, PER 값을 설정
  var roe;
  var pbr;
  var per;
  var equity = 5;
  var stockprice = 10;
  var profit = 20;
  
  // 삼각형 각 꼭지점 좌표
  var points = [
    { x: 200, y: 100 },
    { x: 100, y: 300 },
    { x: 300, y: 300 }
  ];
  
  // 정삼각형의 각 꼭지점 좌표
  var centerX = (points[0].x + points[1].x + points[2].x) / 3;
  var centerY = (points[0].y + points[1].y + points[2].y) / 3;
  
  var sideLength = 280; // 정삼각형의 한 변의 길이
  
  points = [
    { x: centerX, y: centerY - Math.sqrt(3) * sideLength / 3 },
    { x: centerX - sideLength / 2, y: centerY + Math.sqrt(3) * sideLength / 6 },
    { x: centerX + sideLength / 2, y: centerY + Math.sqrt(3) * sideLength / 6 }
  ];
  
  // D3.js를 사용하여 정삼각형 그리기
  var svg = d3.select("#triangleContainer").append("svg")
    .attr("width", 800)
    .attr("height", 400);
  
  svg.append("polygon")
    .attr("points", `${points[0].x},${points[0].y} ${points[1].x},${points[1].y} ${points[2].x},${points[2].y}`)
    .attr("stroke", "#000000")
    .attr("fill", "none")
    .attr("stroke-width", 5); // 선 굵기 설정
  
  // 각 꼭지점에 지표 값 표시
  
  
  // 각 꼭지점에 원 도형 그리기
  svg.append("defs").append("filter")
      .attr("id", "shadow")
      .append("feDropShadow")
      .attr("dx", 0)
      .attr("dy", 4)
      .attr("stdDeviation", 2)
      .attr("flood-color", "#888888");
  
  svg.selectAll("circle")
  .data(points)
  .enter().append("circle")
  .attr("cx", d => d.x)
  .attr("cy", d => d.y)
  .attr("r", 50)  // 원의 반지름
  .attr("fill", (d, i) => ["#ff7473", "#ffc952", "#47b8e0"][i])
  .attr("filter", "url(#shadow)") // 그림자 효과
  .each(function (d) {
    // 각 원의 원래 색상 저장
    d3.select(this).attr("data-original-fill", d3.select(this).attr("fill"));
  })
  .on("mouseover", function (event, d) {
    // Hover 시의 동작
    d3.select(this)
      .transition()
      .duration(500)
      .attr("fill", "#3498db") // Hover 시의 배경색
      .attr("r", 60); // Hover 시의 크기 확대        
      // 텍스트에도 이벤트 전파
      textElements[i].dispatchEvent(new Event("mouseover"));
  
    // 팝업 요소 생성
  })
  .on("mouseout", function () {
    // Hover가 끝날 때의 동작
    d3.select(this)
      .transition()
      .duration(800)
      .attr("fill", function () {
        // 원래 색상으로 복원
        return d3.select(this).attr("data-original-fill");
      })
      .attr("r", 50); // 원래 크기로 복원
      // 텍스트에도 이벤트 전파
      textElements[i].dispatchEvent(new Event("mouseout"));
  });
  
  var textElements = svg.selectAll("text")
    .data(points)
    .enter().append("text")
    .attr("x", d => d.x)
    .attr("y", d => d.y+2)
    .style("cursor", "pointer")  // 커서를 포인터로 변경하여 클릭 가능하도록 합니다.
    .on("click", (d, i) => handleButtonClick(i))  // 클릭 이벤트를 처리할 함수를 지정합니다.
    .on("mouseover", function (event, d) {
      // Hover 시의 동작
      d3.select(this)
        .transition()
        .duration(500)
        .style("fill", "#3498db"); // Hover 시의 텍스트 색상 변경
    })
    .on("mouseout", function () {
      // Hover가 끝날 때의 동작
      d3.select(this)
        .transition()
        .duration(800)
        .style("fill", "#000000"); // 원래 텍스트 색상으로 복원
    })
    .text((d, i) => ["주가", "자본", "이익"][i])
    .attr("fill", "#000000")
    .attr("text-anchor", "middle") // 텍스트를 가운데 정렬
    .attr("dominant-baseline", "middle")// 텍스트를 수직 및 수평 중앙에 정렬
    .style("font-size", "30px") // 텍스트의 크기 조절
    .style("font-weight", "bold");
  
    function handleButtonClick(index) {
      const popupContent = getPopupContent(index);
    
      // 유니크한 ID 생성
      const popupId = `popup-${index}`;
      
      const popupStyles = `
    #${popupId} {
      background: white;
      border: 1px solid #000;
      border-radius: 5px;
      padding: 10px;
    }
    #closeButton-${popupId} {
      position: absolute;
      top: 2px;
      right: 2px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 5px 10px;
      font-size: 14px;
    }
    #closeButton-${popupId}:hover {
      background-color: #2980b9;
    }
  `;
  
  // 위에서 정의한 스타일을 head에 추가
  d3.select("head").append("style").html(popupStyles);
  
  // 팝업 생성 및 스타일 적용
  const popup = svg.append("foreignObject")
    .attr("x", 430)
    .attr("y", centerY - 200)
    .attr("width", 350)
    .attr("height", 300)
    .attr("id", popupId)
    .append("xhtml:div")
    .html(popupContent);
  
  // 팝업 닫기 버튼 추가
  popup.append("button")
    .attr("id", `closeButton-${popupId}`)
    .text("X")
    .on("click", function () {
      // 해당 팝업 제거
      d3.select(`#${popupId}`).remove();
    });
    
      // 화면 밖을 클릭해서 팝업 닫기
      popup.on("click", function () {
        // 팝업 닫기 버튼 클릭 시 해당 팝업 제거
        d3.select(`#${popupId}`).remove();
      });
    
      // 팝업 내부의 클릭 이벤트가 상위로 전파되지 않도록 막기
      popup.on("click", function () {
        d3.event.stopPropagation();
      });
  }
  
  function getPopupContent(index) {
    // 각 버튼에 대한 내용을 반환하는 함수
    switch (index) {
      case 0:
      // "주가" 버튼을 눌렀을 때의 내용
      return `
        <strong>주가에 대한 설명:</strong><br>
        주가는 한 주의 주식을 현재 시장에서 거래되는 가격을 나타냅니다. 주가는 시장에서의 수요와 공급에 의해 결정되며, 회사의 경제적 상태와 성과에 따라 변동할 수 있습니다.<br><br>
        <strong>주가 이해를 위한 예시:</strong><br>
        예를 들어, 회사가 성공적인 실적을 내었을 때 주가는 상승할 수 있습니다. 반대로, 부정적인 소식이 있을 경우 주가는 하락할 수 있습니다.
        `;
  
      case 1:
        // "자본 버튼"에 대한 내용
        return `
          <strong>자본에 대한 설명:</strong><br>
          회사의 자본은 주주에게 소속된 순자산을 나타냅니다. 이는 회사의 소유자들에게 남은 자산으로, 주식의 자본과 이익 잉여금 등으로 이루어져 있습니다.<br><br>
          <strong>자본 중요성:</strong><br>
          자본은 회사가 운영되는 데 필요한 자금을 제공하고, 잠재적인 투자자들에게 회사의 건전성을 나타내는 중요한 지표입니다.
          `;
        
      case 2:
        // "이익" 버튼을 눌렀을 때의 내용
        return `
          <strong>이익에 대한 설명:</strong><br>
          회사의 이익은 수익에서 비용을 뺀 순수익을 의미합니다. 이익은 회사의 경제적 성과를 나타내며, 주주들에게 배당금으로 돌아갈 수 있습니다.<br><br>
          <strong>이익 관련 지표:</strong><br>
          주가수익비율(P/E Ratio)과 같은 지표들은 주가와 이익 사이의 관계를 나타내어 투자자들이 기업의 가치를 판단하는 데 도움을 줍니다.
        `;
    }
    }
   
  // 각 변에 위치한 회사 지점에 값 표시-------> 이게 삼각형에 들어가는 값들

  
    
    
  function updateSalesChart(data){
    salesChart.data.datasets[0].data = data;
    salesChart.update();
  }

  function test(){
    let corp_name = $("#corp_name").val();
    console.log(corp_name);
    
    $("#search_form").attr('onsubmit','return false;');
    $('#search_error').hide();
    $('.summary_card').fadeOut();
    $('.spin-class').show();
    $('#corp_news').html('');
    if(salesChart != undefined) salesChart.destroy();
    if(deptChart != undefined) deptChart.destroy();
    $.ajax({
			type:'post',   //post 방식으로 전송
			url:'/summary/test/',   //데이터를 주고/받을 파일 주소
			data: {
        corp_name: corp_name,
        csrfmiddlewaretoken: window.CSRF_TOKEN,
      },   //위의 변수에 담긴 데이터를 전송해준다.
			success : function(data){   //파일 주고받기가 성공했을 경우. data 변수 안에 값을 담아온다.
        console.log(data)
				$(".chart-example").html(data.chart);  //현재 화면 위 id="message" 영역 안에 data안에 담긴 html 코드를 넣어준다. 
        $("#corp_intro").html(corp_name);
        $("#corp_financial_reports").html(corp_name+" 재무분석")
        $('.summary_card').fadeIn();
        let asset;
        let dept;
        let equity;
        let profit;
        let revenue;
        let netincome;
        let prev_dept,prev_profit,prev_revenue,prev_netincome;
        for (i = 0; i < data.fin_data.length; i++) {
          if (data.fin_data[i].name=="자산총계"){
            asset = data.fin_data[i].thisyear;
          }
          else if(data.fin_data[i].name=="부채총계"){
            dept = data.fin_data[i].thisyear;
            prev_dept = data.fin_data[i].lastyear;
          }
          else if(data.fin_data[i].name=="자본총계"){
            equity = data.fin_data[i].thisyear;
          }
          else if(data.fin_data[i].name=="영업이익"){
            profit = data.fin_data[i].thisyear;
            prev_profit = data.fin_data[i].lastyear;
          }
          else if(data.fin_data[i].name=="매출액"){
            revenue = data.fin_data[i].thisyear;
            prev_revenue = data.fin_data[i].lastyear;
          }
          else if(data.fin_data[i].name=="당기순이익"){
            netincome = data.fin_data[i].thisyear;
            prev_netincome = data.fin_data[i].lastyear;
          }
        } 

        data.corp_news.forEach(function(news,idx){
          $('#corp_news').append("<p class='jb-title' onclick='showPopup("+idx+")'>"+news.title+"</p> \
          <div id='popup"+idx+"' class='popup hide layer'> \
              <div class='content'> \
                  <div class='pop-title'>"+news.title+"</div> \
                  <div class='pop-date'>"+news.date+"</div>\
                  <div class='pop-summary'>" + news.summary +" \
                    <button onclick='closePopup("+idx+")' class='custom-end'>닫기</button> \
                    </div> \
                  <a class='pop-link' target='_blank' href='"+news.link+"'>" + news.link + "</div> \
              </div> \
          </div>");
        })
       
        $('#corp_info').html(data.corp_info);
        $('#financial_summary').html(data.financial_summary);

        $('#stock_data').html("<p class='jb-title'>KS11 : "+data.stock_data.KS11[0].Close+" => "+data.stock_data.KS11[1].Close+"</p> \
                                <a class='nav-link text-center'>변화량 : "+(data.stock_data.KS11[1].Close - data.stock_data.KS11[0].Close).toFixed(2)+"</a> \
                                <p class='jb-title'>KQ11 : "+data.stock_data.KQ11[0].Close+" => "+data.stock_data.KQ11[1].Close+"</p>  \
                                <a class='nav-link text-center'>변화량 : "+(data.stock_data.KQ11[1].Close - data.stock_data.KQ11[0].Close).toFixed(2)+"</a> \
                                <p class='jb-title'>KS200 : "+data.stock_data.KS200[0].Close+" => "+data.stock_data.KS200[1].Close+"</p>\
                                <a class='nav-link text-center'>변화량 : "+(data.stock_data.KS200[1].Close - data.stock_data.KS200[0].Close).toFixed(2)+"</a>");
        
        
        drawDeptChart($('#chart-dept')
        ,[(Math.round(dept*100)/asset).toFixed(2),(Math.round(equity*100)/asset).toFixed(2)]);
        
        drawSalesChart($('#chart-sales2')
        ,[dept/1000,profit/1000,revenue/1000,netincome/1000]);
        
        $("#sales2023").attr('onclick',"updateSalesChart(["+[dept/1000,profit/1000,revenue/1000,netincome/1000]+"]);return false;");
        $("#sales2022").attr('onclick',"updateSalesChart(["+[prev_dept/1000,prev_profit/1000,prev_revenue/1000,prev_netincome/1000]+"]);return false;");
        
        roe.text('ROE: '+data.financial_values.ROE[1]);
      
        pbr.text('PBR: '+data.financial_values.PBR[1]);
      
        per.text('PER: '+data.financial_values.PER[1]);

        drawChart(data.stock_data.current_price,data.financial_values)
			},
      error	: function(xhr, status, error) {  
        $('#search_error').show();
      },
      complete : function(){
        $('.spin-class').hide();
        $("#search_form").attr('onsubmit','return test();');
      }
		});
  }

  const targetTextarea = document.querySelector('#message-input');

  function adjustTextareaHeight() {
      // 텍스트영역 높이를 실제 컨텐츠의 높이로 재설정
      targetTextarea.style.height = 'auto';

      // 텍스트영역 높이를 스크롤 높이에 맞춰 설정
      targetTextarea.style.height = targetTextarea.scrollHeight + 'px';
      targetTextarea.scrollDown = targetTextarea.scrollHeight;
    }

  // 인풋 이벤트가 발생할 때마다 높이 조절 함수를 호출
  targetTextarea.addEventListener('input', adjustTextareaHeight);

  // 페이지 로딩 시 초기 높이 조절
  adjustTextareaHeight();
    
  function showPopup(number) {
    var popup = document.getElementById("popup"+number);
    popup.classList.remove("hide");
    popup.classList.add("show");
  }

  function closePopup(number) {
      var popup = document.getElementById("popup"+number);
      popup.classList.remove("show");
      popup.classList.add("hide");
  }
  // 외부영역 클릭 시 팝업 닫기
  $(document).mouseup(function (e) {
    var popContent = $('#popup');
    if (popContent.has(e.target).length === 0) {
        popContent.addClass('hide');
    }
  });

  $(document).ready(function () {
    // 페이지가 로드될 때 챗봇 초기 인사말 표시
    $('#chatbot_conversation').append("<p class='chatbot-answer'> Hey, 금융에게 재무제표 정보를 물어보세요!</p>");
      roe = svg.append("text")
        .attr("x", 50)
        .attr("y", 180)
        .text('ROE: ')
        .attr("fill", "#000000");
      
      pbr = svg.append("text")
        .attr("x", 180)
        .attr("y", 350)
        .text('PBR: ')
        .attr("fill", "#000000");
      
      per = svg.append("text")
        .attr("x", 310)
        .attr("y", 180)
        .text('PER: ')
        .attr("fill", "#000000");
    });

    function sendMessage() {
      // 사용자가 입력한 질문 가져오기
      let userQuestion = $('#message-input').val();
      // 메시지 전송 후 textarea 비우기
      $('#message-input').val('');
      // 사용자 질문을 대화창에 추가
      $('#chatbot_conversation').append("<p class='user-question'>" + userQuestion + "</p>");
    
      // AJAX를 사용하여 서버에 질문을 전송하고 답변을 받아오는 부분
      $.ajax({
        type: 'post',
        url: '/summary/corp_chatbot/',
        data: {
          data: userQuestion,
          csrfmiddlewaretoken: window.CSRF_TOKEN,
        },
        success: function (data) {
          console.log(data);
    
          // 챗봇의 답변을 대화창에 추가
          $('#chatbot_conversation').append("<p class='chatbot-answer'>" + data.chat_answer + "</p>");
    
          
    
          // placeholder를 다시 보이도록 설정 (생략 가능하나 추가하면 더 확실함)
          $('#message-input').attr("placeholder", "메시지를 입력하세요");

          // 대화창을 맨 아래로 스크롤
          $('.card-custom').scrollTop($('.card-custom')[0].scrollHeight);
        }
      });

      // 대화창을 맨 아래로 스크롤
      $('.card-custom').scrollTop($('.card-custom')[0].scrollHeight);
    }

    $('.card-custom').on('scroll', function () {
      if ($('.card-custom').scrollTop() + $('.card-custom').innerHeight() >= $('.card-custom')[0].scrollHeight) {
        // 맨 아래에 도달한 경우 스크롤을 유지
        $('.card-custom').scrollTop($('.card-custom')[0].scrollHeight);
      }
    });
  // 버튼 요소 참조
  const expandButton = document.getElementById('expandButton');

  // 높이를 변경할 대상 요소 참조
  const targetElement = document.getElementById('expandableCard');

  // 버튼 클릭 이벤트 처리
  expandButton.addEventListener('click', function() {
    // 현재 높이 가져오기
    const currentHeight = targetElement.clientHeight;

    // 새로운 높이 설정 (현재 높이의 두 배)
    const newHeight = currentHeight * 2;

    // 높이 변경 애니메이션
    targetElement.style.transition = 'height 1s ease-in-out';
    targetElement.style.height = newHeight + 'px';

    // 버튼 비활성화
    expandButton.style.opacity = '0';    // 버튼이 완전히 사라진 후 숨기기

    // 클릭 이벤트 리스너 제거
    expandButton.removeEventListener('click', arguments.callee);
  });
    
</script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    // Google Charts 로드
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart(current_price,financial_values) {
      // 가상의 데이터 (적절한 값으로 대체 필요) ----->두 번째 넣을 값
      var pbr = financial_values.PBR[1];
      var per = financial_values.PER[1]; // 동종업계의 per 의 평균을 계산해서 넣어야 함. 우선 10 default 고정
      var eps = financial_values.EPS[1];
      var roe = financial_values.ROE[1];
      var bps = financial_values.BPS[1];
      
      var currentPrice = current_price;
      var epsPer = eps*per;
      var pbrBps = pbr*bps;
      var roe = (eps/roe) * 100;


      // 데이터 배열 생성
      var data = google.visualization.arrayToDataTable([
        ['항목', '적정주가', '현재주가', '주가 차이'],
        ['EPS x PER', epsPer, currentPrice, Math.abs(epsPer - currentPrice)],
        ['ROE', roe, currentPrice, Math.abs(roe - currentPrice)],
      ]);

      // 차트 옵션 설정
      var options = {
        title: '주요지표 분석으로 본 현재 주가의 타당성',
        titleTextStyle: {
          fontSize: 17, // 원하는 크기로 설정
          bold: true     // 굵게 설정 여부 (true 또는 false)
        },
        chartArea: {width: '65%'},
        hAxis: {
          title: '항목',
          minValue: 0
        },
        annotations: {
          alwaysOutside: true,
          textStyle: {
            fontSize: 12,
            auraColor: 'none',
            color: '#555'
          },
          vertical: true
        },
        legend: {
          position: 'bottom' // 'top', 'bottom', 'left', 'right' 중 선택
        },
        series: {
          0: {color: '#3366cc'},  // '예상주가' color
          1: {color: '#dc3912'},    // '현재주가' color
          2: {type: 'line', color: 'orange', lineDashStyle: [4, 4], lineWidth: 8} // '주가 차이' color
        },
        seriesType: 'bars'
      };

      // Combo 차트 생성
      var chart = new google.visualization.ComboChart(document.getElementById('myChart'));

      // 차트 그리기
      chart.draw(data, options);
    }

    document.addEventListener('DOMContentLoaded', function() {
      var usernames = document.querySelector('#username');
      var fullname = usernames.textContent.trim();
      //var maskedName = fullname.substring(0, fullname.length - 1) + '*';
      var nameLength = fullname.length - 8;
      var maskedName = fullname.substring(0, nameLength-1) + '*' + fullname.substring(nameLength, fullname.length - 1);
      usernames.innerText = maskedName;
      /*
      usernames.forEach(function(userElement) {
          var fullname = userElement.textContent.trim();
          var maskedName = fullname.substring(0, fullname.length - 1) + '*';
          userElement.innerText = maskedName + '님 반갑습니다.';
      });
      */
    });
  </script>
  

</body>
</html>

